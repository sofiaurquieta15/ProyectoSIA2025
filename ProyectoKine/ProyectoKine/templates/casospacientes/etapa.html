{% extends 'base_site.html' %}
{% load static %}
{% load dict_filters %}

{% block title %}Etapa {{ num_etapa }} - {{ paciente.nombre }}{% endblock %}

{% block nav_buttons %}
<a href="{% url 'casos:detalle_paciente' paciente.id %}"
   class="bg-white text-black px-4 py-2 rounded-full mr-4 font-semibold shadow">
   ETAPAS
</a>

<a href="{% url 'login:logout' %}"
   class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow">
   CERRAR SESIÓN
</a>
{% endblock %}

{% block content %}

<div class="container mx-auto py-10 px-6">

    <h2 class="text-4xl font-extrabold text-center">ETAPA {{ num_etapa }}</h2>
    <p class="text-center text-xl mb-10">{{ etapa.nombreetapa }}</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- VIDEO -->
        <div class="bg-black h-[350px] flex items-center justify-center rounded-lg shadow">
            <iframe class="w-full h-full"
                    src="{{ etapa.urlvideo }}"
                    frameborder="0"
                    allowfullscreen></iframe>
        </div>

        <!-- PANEL PREGUNTAS -->
        <div class="border p-6 rounded-lg shadow-md bg-white">

            <h3 class="text-3xl font-bold text-center mb-6">PREGUNTAS</h3>

            <form id="form-multipregunta">

                {% for pregunta in preguntas %}
                <div class="mb-10 p-4 border rounded-lg bg-gray-50 pregunta-item"
                     data-pregunta-id="{{ pregunta.id }}">

                    <p class="text-xl font-bold mb-3">
                        {{ forloop.counter }}. {{ pregunta.titulo }}
                    </p>

                    <p class="text-gray-700 mb-3">{{ pregunta.texto }}</p>

                    {% if pregunta.tipo == "MULTIPLE" %}
                        {% with prev=respuestas_previas|dict_get:pregunta.id %}
                        {% for opcion in pregunta.opciones.all %}
                        <div class="mb-3">
                            <label class="flex items-center space-x-3 cursor-pointer">

                                <!-- RADIO -->
                                <input type="radio"
                                       name="pregunta_{{ pregunta.id }}"
                                       value="{{ opcion.id }}"
                                       class="radio-opcion h-5 w-5"
                                       {% if prev == opcion.id %}checked{% endif %}
                                       {% if completada %}disabled{% endif %}>

                                <!-- TEXTO DE OPCIÓN -->
                                <span class="
                                    {% if completada and opcion.is_correct %}
                                        text-green-600 font-bold
                                    {% endif %}
                                    {% if completada and prev == opcion.id and not opcion.is_correct %}
                                        text-red-600 font-bold
                                    {% endif %}
                                ">
                                    {{ opcion.texto_opcion }}
                                </span>
                            </label>

                            {% if completada and opcion.is_correct %}
                                <p class="ml-8 text-sm text-green-700">
                                    <strong>Retroalimentación:</strong> {{ opcion.retroalimentacion }}
                                </p>
                            {% endif %}

                            {% if completada and prev == opcion.id and not opcion.is_correct %}
                                <p class="ml-8 text-sm text-red-700">
                                    <strong>Retroalimentación:</strong> {{ opcion.retroalimentacion }}
                                </p>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endwith %}
                    {% endif %}

                </div>
                {% endfor %}

                <!-- BOTÓN -->
                {% if completada %}
                    <a href="{% if ultima_etapa %}
                                {% url 'casos:detalle_paciente' paciente.id %}
                             {% else %}
                                {% url 'casos:detalle_etapa2' paciente.id num_etapa|add:1 %}
                             {% endif %}"
                       class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-full mt-6 block mx-auto text-center shadow">
                        {% if ultima_etapa %} FINALIZAR CASO {% else %} SIGUIENTE ETAPA {% endif %}
                    </a>

                {% else %}
                    <button id="btn-enviar-total"
                            class="bg-blue-700 text-white font-bold py-3 px-6 rounded-full mt-6 block mx-auto shadow">
                        VALIDAR RESPUESTAS
                    </button>
                {% endif %}

            </form>

        </div>

    </div>

</div>

<!-- MODAL -->
<div id="modal-feedback"
     class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center w-96">
        <h2 id="feedback-title" class="text-2xl font-bold mb-4"></h2>
        <p id="feedback-text" class="mb-6"></p>
        <button id="modal-btn"
                class="bg-blue-700 text-white px-4 py-2 rounded-full font-bold">
            Entendido
        </button>
    </div>
</div>

<script>
let estudiante_id = "{{ request.session.estudiante_id }}";
let siguienteURL = "{% url 'casos:detalle_etapa2' paciente.id num_etapa|add:1 %}";

let debeRedirigir = false; // <<< Nuevo: controla si el modal debe mandar a etapa 2

/* ============= MODAL ============= */
function modalFeedback(title, html, redirigir=false){
    debeRedirigir = redirigir; // guardamos si debe redirigir o no
    document.getElementById("feedback-title").innerHTML = title;
    document.getElementById("feedback-text").innerHTML = html;
    document.getElementById("modal-feedback").classList.remove("hidden");
}

document.getElementById("modal-btn").onclick = () => {
    document.getElementById("modal-feedback").classList.add("hidden");

    // SOLO redirigir si todas las respuestas fueron correctas
    if (debeRedirigir) {
        window.location.href = siguienteURL;
    }
};

/* ============= VALIDACIÓN ============= */
document.getElementById("btn-enviar-total")?.addEventListener("click", function(e){
    e.preventDefault();

    let preguntas = document.querySelectorAll(".pregunta-item");
    let respuestas = [];
    let errores = [];

    preguntas.forEach(p => {

        let pregunta_id = p.dataset.preguntaId;
        let seleccion = p.querySelector("input[type=radio]:checked");

        if(!seleccion){
            errores.push(`Pregunta ${pregunta_id} sin responder.`);
        }

        respuestas.push({
            tipo: "MULTIPLE",
            opcion_id: seleccion ? seleccion.value : "",
            pregunta_id: pregunta_id
        });
    });

    if(errores.length > 0){
        modalFeedback("⚠️ Faltan respuestas", errores.join("<br>"), false);
        return;
    }

    let promesas = respuestas.map(r => {
        return fetch("{% url 'casos:validar_respuesta' %}", {
            method: "POST",
            headers: {"X-CSRFToken": "{{ csrf_token }}"},
            body: new URLSearchParams({...r, estudiante_id})
        }).then(r => r.json());
    });

    Promise.all(promesas).then(res => {

        let incorrectas = res.filter(r => !r.correcto);

        if(incorrectas.length > 0){
            modalFeedback("❌ Hay respuestas incorrectas", "Revisa las alternativas.", false);
            return;
        }

        // TODAS CORRECTAS → redirige al cerrar modal
        modalFeedback("✔ ¡Correcto!", "Todas las respuestas son correctas.", true);
    });

});
</script>

{% endblock %}