{% extends 'base_site.html' %}
{% load static %}

{% block title %}Etapa {{ num_etapa }} - {{ paciente.titulopaciente }}{% endblock %}

{% block nav_buttons %}
<a href="{% url 'casos:detalle_paciente' paciente.id %}"
   class="bg-white text-black px-4 py-2 rounded-full mr-4 font-semibold shadow">
   CASOS PACIENTES
</a>

<a href="{% url 'login:logout' %}"
   class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow">
   CERRAR SESIÃ“N
</a>
{% endblock %}

{% block content %}

<div class="container mx-auto py-10 px-6">

    <h2 class="text-4xl font-extrabold text-center">ETAPA {{ num_etapa }}</h2>
    <p class="text-center text-xl mb-10">{{ etapa.nombreetapa }}</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- VIDEO -->
        <div class="bg-black h-[350px] flex items-center justify-center">
            <iframe class="w-full h-full"
                    src="{{ etapa.urlvideo }}"
                    frameborder="0"
                    allowfullscreen>
            </iframe>
        </div>

        <!-- PREGUNTA -->
       <div class="border p-6 rounded-lg shadow-md">

            <h3 class="text-3xl font-bold text-center mb-4">PREGUNTAS</h3>

            <form id="form-multipregunta">

                {% for pregunta in preguntas %}
                <div class="mb-10 p-4 border rounded-lg bg-gray-50 pregunta-item"
                        data-pregunta-id="{{ pregunta.id }}">
            
                        <p class="text-lg font-bold mb-3 text-xl">
                            {{ forloop.counter }}. {{ pregunta.titulo }}
                        </p>

                        <p class="text-gray-700 mb-3">
                            {{ pregunta.texto }}
                        </p>

                        {% if pregunta.tipo == "MULTIPLE" %}
                        {% for opcion in pregunta.opciones.all %}
                        <label class="flex items-center space-x-3 mb-3 cursor-pointer">
                            <input type="radio"
                                name="pregunta_{{ pregunta.id }}"
                                value="{{ opcion.id }}"
                                class="radio-opcion h-5 w-5">
                            <span>{{ opcion.texto_opcion }}</span>
                        </label>
                        {% endfor %}
                    {% endif %}

                    {% if pregunta.tipo == "ESCRITA" %}
                        <textarea class="respuesta-escrita w-full h-28 p-3 bg-gray-200 rounded-lg"
                            placeholder="Escribe tu respuesta aquÃ­..."
                            data-pregunta-id="{{ pregunta.id }}"></textarea>
                    {% endif %}

                </div>
                {% endfor %}

                <button id="btn-enviar-total"
                        class="bg-blue-700 text-white font-bold py-2 px-6 rounded-full mt-4 block mx-auto">
                    {% if ultima_etapa %} FINALIZAR {% else %} SIGUIENTE {% endif %}
                </button>

            </form>

        </div>

    </div>

</div>

<!-- MODAL -->
<div id="modal-feedback"
     class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
        <h2 class="text-2xl font-bold mb-4" id="feedback-title"></h2>
        <p id="feedback-text" class="mb-6"></p>
        <button onclick="closeModal()"
                class="bg-blue-700 text-white px-4 py-2 rounded-full font-bold">
            Entendido
        </button>
    </div>
</div>

<!-- MODAL FINAL -->
<div id="modal-final"
     class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
        <h2 class="text-2xl font-bold mb-4">ðŸŽ‰ Â¡Caso Finalizado!</h2>
        <p class="mb-6">Has terminado todas las etapas.</p>
        <a href="{% url 'casos:detalle_paciente' paciente.id %}"
           class="bg-blue-700 text-white px-4 py-2 rounded-full font-bold">
           Volver a Etapas
        </a>
    </div>
</div>

<script>

let estudiante_id = "{{ request.session.estudiante_id }}";
let ultima = {{ ultima_etapa|yesno:"true,false" }};
let siguienteURL = "{% if not ultima_etapa %}{% url 'casos:detalle_etapa' paciente.id num_etapa|add:1 %}{% endif %}";

/* ============================
      MODAL FEEDBACK
   ============================ */
function modalFeedback(title, htmlText) {
    document.getElementById("feedback-title").innerHTML = title;
    document.getElementById("feedback-text").innerHTML = htmlText || "";
    document.getElementById("modal-feedback").classList.remove("hidden");
}

function closeModal() {
    document.getElementById("modal-feedback").classList.add("hidden");
}

/* ============================
       BOTÃ“N SIGUIENTE
   ============================ */
const btnEnviar = document.getElementById("btn-enviar-total");

if (btnEnviar) {
    btnEnviar.addEventListener("click", function(e) {
        e.preventDefault();

        let preguntas = document.querySelectorAll(".pregunta-item");
        let respuestas = [];
        let errores = [];

        /* =============================
           1) RECOLECTAR RESPUESTAS
        ============================== */
        preguntas.forEach(p => {

            let pregunta_id = p.dataset.preguntaId;
            let textarea = p.querySelector("textarea");
            let seleccionMultiple = p.querySelector("input[type=radio]:checked");

            if (textarea) {
                // ========= PREGUNTA ESCRITA =========
                let txt = textarea.value.trim();

                if (!txt) {
                    errores.push({
                        numero: pregunta_id,
                        texto: "Debe escribir una respuesta."
                    });
                }

                respuestas.push({
                    tipo: "ESCRITA",
                    texto_respuesta: txt,
                    pregunta_id: pregunta_id
                });

            } else {
                // ========= PREGUNTA MULTIPLE =========
                if (!seleccionMultiple) {
                    errores.push({
                        numero: pregunta_id,
                        texto: "Debe seleccionar una alternativa."
                    });
                }

                respuestas.push({
                    tipo: "MULTIPLE",
                    opcion_id: seleccionMultiple ? seleccionMultiple.value : "",
                    pregunta_id: pregunta_id
                });
            }

        });

        /* =============================
           2) SI HAY ERRORES DE ENTRADA
        ============================== */
        if (errores.length > 0) {
            let msg = "";
            errores.forEach(e => {
                msg += `<strong>Pregunta ${e.numero} - Incompleta</strong><br>${e.texto}<br><br>`;
            });
            modalFeedback("âš ï¸ Respuestas incompletas", msg);
            return;
        }

        /* =============================
           3) VALIDAR EN EL BACKEND
        ============================== */
        let incorrectas = [];
        let retro_generales = [];

        let promesas = respuestas.map(r => {
            return fetch("{% url 'casos:validar_respuesta' %}", {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                body: new URLSearchParams({
                    ...r,
                    estudiante_id
                })
            })
            .then(res => res.json())
            .then(res => {

                if (!res.correcto) {
                    incorrectas.push({
                        pregunta_id: r.pregunta_id,
                        retro: res.retroalimentacion || "Respuesta incorrecta."
                    });
                } else {
                    retro_generales.push({
                        pregunta_id: r.pregunta_id,
                        retro: res.retroalimentacion_general || ""
                    });
                }

            });
        });

        /* =============================
           4) PROCESAR RESULTADOS
        ============================== */
        Promise.all(promesas).then(() => {

            // âŒ HAY INCORRECTAS
            if (incorrectas.length > 0) {
                let texto = "";
                incorrectas.forEach(i => {
                    texto += `<strong>Pregunta ${i.pregunta_id} - Incorrecta</strong><br>`;
                    texto += `${i.retro}<br><br>`;
                });

                modalFeedback("âŒ Respuestas incorrectas", texto);
                return;
            }

            // âœ”ï¸ TODAS CORRECTAS
            let textoBueno = "";
            retro_generales.forEach(r => {
                textoBueno += `<strong>Pregunta ${r.pregunta_id}:</strong><br>${r.retro}<br><br>`;
            });

            modalFeedback("âœ… Todas correctas", textoBueno);

            // Avanzar al cerrar el modal
            document.querySelector("#modal-feedback button").onclick = function () {
                document.getElementById("modal-feedback").classList.add("hidden");

                if (ultima) {
                    document.getElementById("modal-final").classList.remove("hidden");
                } else {
                    window.location.href = siguienteURL;
                }
            };

        });

    });
}

</script>

{% endblock %}