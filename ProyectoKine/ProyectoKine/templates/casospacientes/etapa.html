{% extends 'base_site.html' %}
{% load static %}
{% load dict_filters %}

{% block title %}Etapa {{ num_etapa }} - {{ etapa.nombreetapa }}{% endblock %}

{% block nav_buttons %}
<a href="{% url 'cursosestudiante:ver_avances' %}"
    class="bg-white hover:bg-gray-100 text-black font-bold py-1 px-3 rounded-full shadow transition">
    MI AVANCE
</a>
<a href="{% url 'cursosestudiante:lista_cursos' %}"
    class="bg-white hover:bg-gray-100 text-black font-bold py-1 px-3 rounded-full shadow transition">
    MIS CURSOS
</a>
<a href="{% url 'cursosestudiante:solicitar_revision' %}"
        class="bg-white hover:bg-gray-100 text-black font-bold py-1 px-3 rounded-full shadow transition">
        SOLICITAR REVISION
    </a>
<a href="{% url 'casos:lista_casos' paciente.id_curso.id %}"
    class="bg-white hover:bg-gray-100 text-black font-bold py-1 px-3 rounded-full shadow transition">
    PACIENTES
</a>
<a href="{% url 'casos:detalle_paciente' paciente.id %}"
    class="bg-white hover:bg-gray-100 text-black font-bold py-1 px-3 rounded-full shadow transition">
    ETAPAS
 </a>
<a href="{% url 'login:logout' %}"
   class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full shadow font-bold transition">
   CERRAR SESIÓN
</a>
{% endblock %}

{% block content %}

<style>
    /* COLOR UNIFICADO CON AVANCES */
    .border-blue-custom {
        border: 4px solid #1e3a8a; /* Azul oscuro */
    }
    .btn-blue-custom {
        background-color: #1e3a8a;
    }
    .btn-blue-custom:hover {
        background-color: #1e40af;
    }
    /* Ícono de estado */
    .status-icon {
        font-family: sans-serif;
    }
</style>

<div class="container mx-auto py-10 px-4 max-w-5xl">
  
    <h2 class="text-4xl font-extrabold text-center text-gray-900 uppercase">ETAPA {{ num_etapa }}</h2>
    <p class="text-center text-xl mb-10 font-semibold text-blue-900">{{ etapa.nombreetapa }}</p>
    <p class="text-xl text-gray-500 text-center">
        Responde atentamente las preguntas según el video correspondiente:
    </p>

    <div class="space-y-8">
        {% for pregunta in preguntas %}
        <div id="pregunta-box-{{ pregunta.id }}" class="pregunta-item flex flex-col md:flex-row gap-8" data-pregunta-id="{{ pregunta.id }}">

            <div class="w-full md:w-1/2 bg-black h-[300px] md:h-[350px] flex items-center justify-center rounded-lg shadow-lg border-blue-custom overflow-hidden">
                <iframe class="w-full h-full"
                        src="{{ pregunta.embed_url }}"
                        title="Video de la pregunta"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin"
                        allowfullscreen></iframe>
            </div>

            <div class="w-full md:w-1/2 p-6 rounded-lg shadow-lg bg-white relative border-blue-custom">
                <div class="status-icon absolute top-4 right-4 text-3xl"></div>

                <h3 class="text-2xl font-bold mb-4 text-gray-800">{{ pregunta.titulo }}</h3>
                <p class="text-gray-700 mb-6">{{ pregunta.texto }}</p>

                {% if pregunta.tipo == "MULTIPLE" %}
                    {% with prev=respuestas_previas|dict_get:pregunta.id %}
                    <div class="space-y-3">
                    {% for opcion in pregunta.opciones.all %}
                    <div>
                        <label class="flex items-start space-x-3 cursor-pointer p-2 rounded hover:bg-gray-50 transition">
                            <input type="radio" name="pregunta_{{ pregunta.id }}" value="{{ opcion.id }}"
                                   class="radio-opcion h-5 w-5 mt-1 text-blue-900 focus:ring-blue-900" 
                                   {% if prev == opcion.id %}checked{% endif %}
                                   {% if completada %}disabled{% endif %}>
                            
                            <div class="flex-1">
                                <span class="text-gray-800 font-medium">{{ opcion.texto_opcion }}</span>
                                
                                {% if completada and opcion.is_correct %}
                                    <span class="text-green-600 font-bold text-xl ml-2">✔</span>
                                {% endif %}
                                
                                {% if completada and prev == opcion.id and not opcion.is_correct %}
                                    <span class="text-red-600 font-bold text-xl ml-2">✘ (Tu respuesta)</span>
                                {% endif %}

                                {% if completada and opcion.is_correct %}
                                <div class="mt-2 p-3 bg-green-50 border border-green-300 rounded-lg text-green-900 text-sm">
                                    <strong>Retroalimentación:</strong> {{ opcion.retroalimentacion }}
                                </div>
                                {% endif %}
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                    </div>
                    {% endwith %}
                {% endif %}

                <div class="retro-error mt-4 p-3 rounded-lg bg-red-50 border border-red-300 text-red-800 font-bold text-sm hidden"></div>

            </div>
        </div>
        {% endfor %}
    </div>

    {% if completada %}
        <a href="{% if ultima_etapa %}
                    {% url 'casos:detalle_paciente' paciente.id %}
                 {% else %}
                    {% url 'casos:detalle_etapa2' paciente.id num_etapa|add:1 %}
                 {% endif %}"
           class="btn-blue-custom text-white font-bold py-3 px-8 rounded-full mt-10 block mx-auto text-center shadow-lg transition w-full md:w-auto uppercase">
            {% if ultima_etapa %} FINALIZAR CASO {% else %} SIGUIENTE ETAPA {% endif %}
        </a>
    {% else %}
        <button id="btn-enviar-total"
                class="btn-blue-custom text-white font-bold py-3 px-8 rounded-full mt-10 block mx-auto shadow-lg transition w-full md:w-auto uppercase">
            VALIDAR RESPUESTAS
        </button>
        <p class="text-l text-gray-500 text-center mt-4">
            *Recuerda que debes responder todas las preguntas correctamente para pasar a la siguiente etapa.
        </p>
    {% endif %}

</div>

<div id="modal-feedback" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 px-4">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center w-full max-w-md border-blue-custom">
        <h2 id="feedback-title" class="text-2xl font-bold mb-4"></h2>
        <div id="feedback-text" class="mb-6 text-gray-700 max-h-96 overflow-y-auto"></div>
        
        <button id="modal-btn"
                class="btn-blue-custom text-white px-8 py-2 rounded-full font-bold shadow transition">
            Entendido
        </button>
    </div>
</div>

<script>
let estudiante_id = "{{ request.session.estudiante_id }}";
let siguienteURL = "{% url 'casos:detalle_etapa2' paciente.id num_etapa|add:1 %}";

// === FUNCIONES MODAL ===
function mostrarModal(titulo, htmlMensaje, esExito) {
    const modal = document.getElementById("modal-feedback");
    document.getElementById("feedback-title").innerText = titulo;
    
    // Usamos innerHTML para permitir saltos de línea <br> y negritas <b>
    document.getElementById("feedback-text").innerHTML = htmlMensaje;
    
    // Alinear texto a la izquierda si son errores
    if(!esExito){
        document.getElementById("feedback-text").classList.add("text-left");
    } else {
        document.getElementById("feedback-text").classList.remove("text-left");
    }

    modal.classList.remove("hidden");
    
    const btn = document.getElementById("modal-btn");
    btn.onclick = function() {
        modal.classList.add("hidden");
        if (esExito) {
            window.location.href = siguienteURL;
        }
    };
}

// === LÓGICA DE ENVÍO ===
document.getElementById("btn-enviar-total")?.addEventListener("click", function(e){
    e.preventDefault();

    let itemsPreguntas = document.querySelectorAll(".pregunta-item");
    let respuestas = [];
    let faltantes = false;

    // 1. Limpiar errores previos (quitar bordes rojos, mensajes y X)
    document.querySelectorAll(".retro-error").forEach(el => el.classList.add("hidden"));
    itemsPreguntas.forEach(div => div.querySelector(".bg-white").classList.remove("border-red-500", "border-2"));
    
    // Limpiar las X anteriores (buscamos por la clase que le pondremos: 'mark-x')
    document.querySelectorAll(".mark-x").forEach(el => el.remove());

    // Diccionario para saber el número de pregunta visual (1, 2, 3...) basado en su ID
    let mapPreguntaNumero = {};

    // 2. Recolectar respuestas
    itemsPreguntas.forEach((item, index) => {
        let pId = item.dataset.preguntaId;
        mapPreguntaNumero[pId] = index + 1; // Guardamos que el ID x es la Pregunta 1, etc.

        let seleccionado = item.querySelector(`input[name="pregunta_${pId}"]:checked`);

        if (!seleccionado) {
            faltantes = true;
            let card = item.querySelector(".bg-white");
            card.classList.add("border-red-500", "border-2"); 
        } else {
            respuestas.push({
                pregunta_id: pId,
                opcion_id: seleccionado.value
            });
        }
    });

    if (faltantes) {
        mostrarModal("⚠️ Faltan respuestas", "Por favor, responde todas las preguntas antes de validar.", false);
        return; 
    }

    // 3. Enviar al backend
    fetch("{% url 'casos:validar_respuesta' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            estudiante_id: estudiante_id,
            respuestas: respuestas
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            // --- TODO CORRECTO: Construir mensaje de éxito detallado ---
            
            let mensajeExitoHTML = "";
            
            // data.aciertos es la lista que enviamos desde el backend
            if (data.aciertos) {
                data.aciertos.forEach(item => {
                    let num = mapPreguntaNumero[item.pregunta_id] || "?";
                    mensajeExitoHTML += `
                        <div class="mb-4 border-b pb-2 last:border-0">
                            <p class="font-bold text-lg text-green-700">Pregunta ${num}:</p>
                            <p class="text-gray-700 text-md mt-1">${item.retro}</p>
                        </div>
                    `;
                });
            }

            mensajeExitoHTML += `<p class="font-bold text-center mt-6 text-xl text-blue-800">¡Ya puedes avanzar a la siguiente etapa!</p>`;

            // Mostrar el modal con redirect=true (el tercer parámetro)
            mostrarModal("¡Todas correctas!", mensajeExitoHTML, true);

        } else {
            // --- HAY ERRORES (Esta parte queda igual que antes) ---
            
            let mensajeHTML = "";
            
            data.errores.forEach(err => {
                let num = mapPreguntaNumero[err.pregunta_id] || "?";

                mensajeHTML += `
                    <div class="mb-4 border-b pb-2 last:border-0">
                        <p class="font-bold text-lg text-red-700">Pregunta ${num}</p>
                        <p class="text-gray-800"><strong>Respuesta marcada:</strong> ${err.opcion_texto}</p>
                        <p class="text-gray-600 text-sm mt-1"><em>${err.retro}</em></p>
                    </div>
                `;

                // Pintar la X (Lógica visual existente)
                let container = document.getElementById(`pregunta-box-${err.pregunta_id}`);
                if (container) {
                    let card = container.querySelector(".bg-white");
                    card.classList.add("border-red-500", "border-2");

                    let radioInput = container.querySelector(`input[value="${err.opcion_id}"]`);
                    if(radioInput){
                        let labelPadre = radioInput.closest("label");
                        let spanX = document.createElement("span");
                        spanX.className = "mark-x text-red-600 font-bold ml-3 text-xl"; 
                        spanX.innerText = "✘"; 
                        labelPadre.appendChild(spanX);
                    }
                }
            });

            mensajeHTML += `<p class="font-bold text-center mt-4 text-xl">¡Corrígelas para avanzar!</p>`;

            mostrarModal("Tienes respuesta(s) incorrecta(s)", mensajeHTML, false);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        mostrarModal("Error", "Ocurrió un error de conexión.", false);
    });
});
</script>


{% endblock %}