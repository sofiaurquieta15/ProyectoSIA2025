{% extends 'base_site.html' %}
{% load static %}

{% block title %}Etapa {{ num_etapa }} - Exploraciones{% endblock %}

{% block nav_buttons %}
<a href="{% url 'casos:detalle_paciente' paciente.id %}"
   class="bg-white text-black px-4 py-2 rounded-full mr-4 font-semibold shadow">
   ETAPAS
</a>

<a href="{% url 'login:logout' %}"
   class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow">
   CERRAR SESIÓN
</a>
{% endblock %}

{% block content %}

<div class="container mx-auto py-10 px-6">

    <h2 class="text-4xl font-extrabold text-center mb-2">ETAPA {{ num_etapa }}</h2>
    <p class="text-center text-xl mb-10">{{ etapa.nombreetapa }}</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- VIDEO -->
        <div class="bg-black h-[350px] flex items-center justify-center rounded-lg shadow-lg">
            <iframe id="video-exploracion"
                    class="w-full h-full"
                    src="{{ exploraciones.0.urlvideo }}"
                    frameborder="0"
                    allowfullscreen>
            </iframe>
        </div>

        <!-- PANEL DERECHO -->
        <div class="p-6 rounded-lg shadow-md border bg-white">

            <h3 class="text-3xl font-bold text-center mb-6">Exploraciones</h3>

            <!-- BOTONES -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                {% for exp in exploraciones %}
                <button type="button"
                        class="btn-exp px-4 py-2 rounded-lg font-bold shadow
                               {% if forloop.first %} bg-blue-700 text-white {% else %} bg-gray-200 {% endif %}"
                        data-exp-id="{{ exp.id }}"
                        data-video="{{ exp.urlvideo }}"
                        data-instruccion="{{ exp.instruccion|escapejs }}">
                    {{ exp.titulo }}
                </button>
                {% endfor %}
            </div>

            <!-- INSTRUCCIÓN -->
            <p id="texto-instruccion" class="text-gray-700 text-lg mb-4">
                {{ exploraciones.0.instruccion }}
            </p>

            {% if completada %}
                <!-- MODO SOLO LECTURA (ETAPA YA COMPLETADA) -->
                <div id="box-respuesta" class="p-4 bg-green-50 border border-green-300 rounded-lg mb-4">
                    <p class="font-semibold mb-1">Tu respuesta:</p>
                    <p id="respuesta-texto"></p>
                </div>

                <div id="box-retro" class="p-4 bg-blue-50 border border-blue-300 rounded-lg">
                    <p class="font-semibold mb-1">Retroalimentación del docente:</p>
                    <p id="retro-texto"></p>
                </div>
            {% else %}
                <!-- MODO EDICIÓN -->
                <textarea id="respuesta-exp"
                          class="w-full h-32 p-3 rounded-lg bg-gray-200"
                          placeholder="Escribe tu respuesta aquí…"></textarea>

                <button id="btn-guardar-exp"
                        class="bg-blue-700 text-white font-bold px-6 py-2 rounded-full mt-6 block mx-auto shadow">
                    GUARDAR RESPUESTAS
                </button>
            {% endif %}

        </div>
    </div>

    <!-- BOTÓN SIGUIENTE / FINAL -->
    <button id="btn-finalizar"
            class="font-bold px-6 py-2 rounded-full mt-10 block mx-auto shadow
                   {% if completada %} bg-green-700 text-white {% else %} bg-gray-400 text-white cursor-not-allowed {% endif %}"
            {% if not completada %} disabled {% endif %}>
        {% if ultima_etapa %} FINALIZAR CASO {% else %} SIGUIENTE ETAPA {% endif %}
    </button>

</div>

<!-- MODAL -->
<div id="modal-feedback"
     class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center w-96">
        <h2 class="text-2xl font-bold mb-4" id="feedback-title"></h2>
        <p id="feedback-text" class="mb-6"></p>
        <button id="btn-modal-ok"
                class="bg-blue-700 text-white px-4 py-2 rounded-full font-bold">
            Entendido
        </button>
    </div>
</div>

<script>
/* ==========================
   VARIABLES BÁSICAS
========================== */
const estudiante_id = "{{ request.session.estudiante_id }}";
const completada = {{ completada|yesno:"true,false" }};
const ultima = {{ ultima_etapa|yesno:"true,false" }};
const siguienteURL = "{% url 'casos:detalle_etapa3' paciente.id num_etapa|add:1 %}";

const respuestasServer = JSON.parse('{{ respuestas_estudiante_json|escapejs }}');
const retroServer = JSON.parse('{{ retro_exploraciones_json|escapejs }}');

const expButtons = Array.from(document.querySelectorAll(".btn-exp"));
const expIds = expButtons.map(b => b.dataset.expId);

let expActualId = expIds.length > 0 ? expIds[0] : null;

const textarea = document.getElementById("respuesta-exp");
const btnGuardar = document.getElementById("btn-guardar-exp");
const btnFinalizar = document.getElementById("btn-finalizar");

/* MODAL */
function abrirModal(t, txt){
    document.getElementById("feedback-title").innerHTML = t;
    document.getElementById("feedback-text").innerHTML = txt;
    document.getElementById("modal-feedback").classList.remove("hidden");
}
document.getElementById("btn-modal-ok").onclick = () => {
    document.getElementById("modal-feedback").classList.add("hidden");
};

/* ==========================
   MODO COMPLETADA: MOSTRAR TARJETAS
========================== */
function actualizarTarjetas(expID){
    const r = respuestasServer[expID] || "—";
    const retro = retroServer[expID] || "—";

    const rNode = document.getElementById("respuesta-texto");
    const retroNode = document.getElementById("retro-texto");
    if (rNode) rNode.innerText = r;
    if (retroNode) retroNode.innerText = retro;
}

/* ==========================
   MODO EDICIÓN: ESTADO TEMPORAL
========================== */
let respuestasTemp = {};
if (!completada) {
    respuestasTemp = Object.assign({}, respuestasServer);

    if (expActualId && textarea) {
        textarea.value = respuestasTemp[expActualId] || "";
    }
}

function guardarTemporal(){
    if (!completada && textarea && expActualId){
        respuestasTemp[expActualId] = textarea.value;
    }
}

/* ==========================
   CAMBIO DE EXPLORACIÓN
========================== */
expButtons.forEach(btn => {
    btn.addEventListener("click", function(){

        // Guardar lo que haya escrito en la exploración actual (modo edición)
        if (!completada) {
            guardarTemporal();
        }

        // Estilos de botones
        expButtons.forEach(b => {
            b.classList.remove("bg-blue-700","text-white");
            b.classList.add("bg-gray-200");
        });
        this.classList.remove("bg-gray-200");
        this.classList.add("bg-blue-700","text-white");

        // Actualizar id + video + texto
        expActualId = this.dataset.expId;
        document.getElementById("video-exploracion").src = this.dataset.video;
        document.getElementById("texto-instruccion").innerText = this.dataset.instruccion;

        if (completada) {
            // Solo lectura: actualizar tarjetas
            actualizarTarjetas(expActualId);
        } else if (textarea) {
            // Edición: cargar texto temporal
            textarea.value = respuestasTemp[expActualId] || "";
        }
    });
});

/* ==========================
   CARGA INICIAL
========================== */
if (completada && expActualId){
    // Mostrar respuesta y retro de la primera exploración al entrar
    actualizarTarjetas(expActualId);
}

/* ==========================
   GUARDAR TODAS LAS RESPUESTAS
========================== */
if (btnGuardar && !completada){
    btnGuardar.addEventListener("click", function(){

        guardarTemporal();

        // Verificar que todas las exploraciones tengan texto
        const faltan = expIds.filter(id => {
            const txt = respuestasTemp[id];
            return !txt || txt.trim() === "";
        });

        if (faltan.length > 0){
            let msg = "Faltan respuestas en las siguientes exploraciones:<br><br>";
            faltan.forEach(id => {
                const btn = document.querySelector(`.btn-exp[data-exp-id="${id}"]`);
                const nombre = btn ? btn.textContent.trim() : ("Exploración " + id);
                msg += "• " + nombre + "<br>";
            });
            abrirModal("⚠ Respuestas incompletas", msg);
            return;
        }

        // Enviar todas
        const promesas = expIds.map(id => {
            return fetch("{% url 'casos:guardar_exploracion' %}", {
                method: "POST",
                headers: {"X-CSRFToken": "{{ csrf_token }}"},
                body: new URLSearchParams({
                    estudiante_id: estudiante_id,
                    exploracion_id: id,
                    texto_respuesta: respuestasTemp[id]
                })
            }).then(r => r.json());
        });

        Promise.all(promesas).then(results => {
            const error = results.find(r => !r.ok);
            if (error){
                abrirModal("Error", error.error || "Ocurrió un problema al guardar.");
                return;
            }

            abrirModal("✅ Respuestas guardadas",
                       "Tus respuestas fueron registradas. Ahora puedes avanzar a la siguiente etapa.");

            // Marcar en el front
            if (btnGuardar){
                btnGuardar.disabled = true;
                btnGuardar.classList.remove("bg-blue-700");
                btnGuardar.classList.add("bg-gray-400","cursor-not-allowed");
                btnGuardar.textContent = "RESPUESTAS GUARDADAS";
            }

            if (btnFinalizar){
                btnFinalizar.disabled = false;
                btnFinalizar.classList.remove("bg-gray-400","cursor-not-allowed");
                btnFinalizar.classList.add("bg-green-700");
            }
        });
    });
}

/* ==========================
   BOTÓN SIGUIENTE / FINALIZAR
========================== */
btnFinalizar?.addEventListener("click", function(){
    if (this.disabled) return;

    if (ultima){
        // Si esta fuera la última etapa (no es tu caso ahora)
        window.location.href = "{% url 'casos:detalle_paciente' paciente.id %}";
    } else {
        // Ir a ETAPA 3
        window.location.href = siguienteURL;
    }
});
</script>

{% endblock %}