{% extends 'base_site.html' %}
{% load static %}

{% block title %}Etapa {{ num_etapa }} - {{ etapa.nombreetapa }}{% endblock %}

{% block nav_buttons %}
<a href="{% url 'cursosestudiante:ver_avances' %}"
    class="bg-white hover:bg-gray-100 text-black font-bold py-1 px-3 rounded-full shadow transition">
    MI AVANCE
</a>
<a href="{% url 'cursosestudiante:lista_cursos' %}"
    class="bg-white hover:bg-gray-100 text-black font-bold py-1 px-3 rounded-full shadow transition">
    MIS CURSOS
</a>
<a href="{% url 'cursosestudiante:solicitar_revision' %}"
    class="bg-white hover:bg-gray-100 text-black font-bold py-1 px-3 rounded-full shadow transition">
    SOLICITAR REVISION
</a>
<a href="{% url 'casos:lista_casos' paciente.id_curso.id %}"
    class="bg-white hover:bg-gray-100 text-black font-bold py-1 px-3 rounded-full shadow transition">
    PACIENTES
</a>
<a href="{% url 'casos:detalle_paciente' paciente.id %}"
    class="bg-white hover:bg-gray-100 text-black font-bold py-1 px-3 rounded-full shadow transition">
    ETAPAS
 </a>
<a href="{% url 'login:logout' %}"
   class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full shadow font-bold transition">
   CERRAR SESIÓN
</a>
{% endblock %}

{% block content %}

<style>
    /* COLOR UNIFICADO CON AVANCES */
    .border-blue-custom {
        border: 4px solid #1e3a8a; /* Azul oscuro */
    }
    .btn-blue-custom {
        background-color: #1e3a8a;
        color: white;
    }
    .btn-blue-custom:hover {
        background-color: #1e40af;
    }
</style>

<div class="container mx-auto py-10 px-4 max-w-5xl">

    <h2 class="text-4xl font-extrabold text-center text-gray-900 uppercase">ETAPA {{ num_etapa }}</h2>
    <p class="text-center text-xl mb-10 font-semibold text-blue-900">{{ etapa.nombreetapa }}</p>
    <p class="text-xl text-gray-500 text-center mb-4">
        Realice el diagnóstico correspondiente al video:
    </p>
    <div class="flex flex-col md:flex-row gap-8">

        <div class="w-full md:w-1/2 bg-black h-[300px] md:h-[400px] flex items-center justify-center rounded-lg shadow-lg border-blue-custom overflow-hidden">
            <iframe class="w-full h-full"
                    src="{{ pregunta.embed_url }}"
                    title="Video de la pregunta"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin"
                    allowfullscreen></iframe>
            </iframe>
        </div>

        <div class="w-full md:w-1/2 p-8 rounded-lg shadow-lg bg-white border-blue-custom flex flex-col">

            <h3 class="text-2xl font-bold text-center mb-2 text-gray-900">{{ pregunta.titulo }}</h3>
            
            <p class="text-center text-blue-900 mb-6 font-semibold">
                Realice el diagnóstico correspondiente al caso
            </p>

            <p class="text-gray-700 mb-6 leading-relaxed">{{ pregunta.texto }}</p>

            {% if completada %}
                
                <div class="space-y-6 flex-grow">
                    <div class="p-4 bg-gray-100 border border-gray-300 rounded-lg">
                        <p class="font-bold text-blue-900 mb-2">Tu Diagnóstico:</p>
                        <p class="text-gray-800 italic whitespace-pre-wrap">{{ respuesta }}</p>
                    </div>

                    {% if pregunta.retroalimentacion_general %}
                    <div class="p-4 bg-green-50 border border-green-300 rounded-lg">
                        <p class="font-bold text-green-900 mb-2">Retroalimentación Docente:</p>
                        <p class="text-green-800 whitespace-pre-wrap">{{ pregunta.retroalimentacion_general }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <a href="{% url 'casos:detalle_paciente' paciente.id %}"
                    class="btn-blue-custom font-bold py-3 px-8 rounded-full mt-8 block mx-auto text-center shadow-lg transition w-full uppercase">
                    VOLVER AL PACIENTE
                </a>

            {% else %}

                <textarea id="respuesta-final"
                          class="w-full flex-grow h-40 p-4 bg-gray-50 border-2 border-gray-300 rounded-lg focus:border-blue-900 focus:ring-1 focus:ring-blue-900 outline-none transition resize-none text-gray-800 mb-6"
                          placeholder="Escribe aquí tu diagnóstico final..."></textarea>

                <button id="btn-enviar"
                        class="btn-blue-custom font-bold px-8 py-3 rounded-full block mx-auto shadow-lg transition w-full uppercase">
                    ENVIAR DIAGNÓSTICO
                </button>
                <p class="text-l text-gray-500 text-center mt-4">
                    *Recuerda que en caso de dudas sobre cualquier respuesta de las etapas puedes realizar tus consultas en 
                    "Solicitud de Revisión".
                </p>                
            {% endif %}
        </div>
    </div>

</div>

<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 px-4">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center w-full max-w-md border-blue-custom">
        <h2 class="text-2xl font-bold mb-4" id="modal-titulo"></h2>
        <div id="modal-texto" class="mb-6 text-gray-700"></div>
        <button id="btn-modal-ok"
                class="btn-blue-custom text-white px-8 py-2 rounded-full font-bold shadow transition">
            Entendido
        </button>
    </div>
</div>

<script>
let estudiante_id = "{{ request.session.estudiante_id }}";
let pregunta_id = "{{ pregunta.id }}";

// Variable para controlar qué hace el botón del modal
let modalRedirect = false;

// MODAL
function abrirModal(t, msg, redirect = false){
    const tituloNode = document.getElementById("modal-titulo");
    const textoNode = document.getElementById("modal-texto");
    
    tituloNode.innerText = t;
    textoNode.innerHTML = msg;

    // Colores según éxito o error
    if (redirect) {
        tituloNode.className = "text-2xl font-bold mb-4 text-green-700";
    } else {
        tituloNode.className = "text-2xl font-bold mb-4 text-red-700";
    }

    // Guardamos si debe redirigir o no
    modalRedirect = redirect;

    document.getElementById("modal").classList.remove("hidden");
}

document.getElementById("btn-modal-ok")?.addEventListener("click", () => {

    document.getElementById("modal").classList.add("hidden");

    // Si el modal fue invocado con redirect = true → ir a detalle
    if(modalRedirect){
        window.location.href = "{% url 'casos:detalle_paciente' paciente.id %}";
    }
});

// ENVIAR RESPUESTA
document.getElementById("btn-enviar")?.addEventListener("click", function(){

    let texto = document.getElementById("respuesta-final").value.trim();

    if(texto === ""){
        abrirModal("⚠ Respuesta vacía", "Por favor escribe tu diagnóstico.", false);
        return;
    }

    fetch("{% url 'casos:validar_respuesta' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json", // <--- IMPORTANTE: Avisamos que enviamos JSON
            "X-CSRFToken": "{{ csrf_token }}"
        },
        // Enviamos el cuerpo como JSON string
        body: JSON.stringify({
            estudiante_id: estudiante_id,
            // En etapa 3 enviamos una "lista" con un solo elemento para reutilizar la lógica del backend
            respuestas: [{
                pregunta_id: pregunta_id,
                texto_respuesta: texto
            }],
            // También enviamos texto_respuesta suelto por si tu backend lo busca así
            texto_respuesta: texto, 
            pregunta_id: pregunta_id 
        })
    })
    .then(r => r.json())
    .then(data => {
        if(data.ok){
            let msgExito = `
                <div class="text-green-700 mb-4">
                    <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    <p class="text-lg font-semibold">¡Diagnóstico enviado correctamente!</p>
                </div>
                <p class="text-gray-600 text-sm mt-2">${data.retro || ""}</p>
            `;
            
            abrirModal(
                "¡Excelente!",
                msgExito,
                true //redirige CUANDO hay éxito
            );
        } else {
            abrirModal("Error", data.error || "Ocurrió un error al guardar.", false);
        }
    })
    .catch(err => {
        console.error(err);
        abrirModal("Error", "Error de conexión al servidor.", false);
    });
});
</script>

{% endblock %}