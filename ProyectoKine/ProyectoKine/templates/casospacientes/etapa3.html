{% extends 'base_site.html' %}
{% load static %}

{% block title %}Etapa 3 - Diagnóstico{% endblock %}

{% block nav_buttons %}
<a href="{% url 'casos:detalle_paciente' paciente.id %}"
   class="bg-white text-black px-4 py-2 rounded-full mr-4 shadow font-semibold">
   ETAPAS
</a>

<a href="{% url 'login:logout' %}"
   class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full shadow font-bold">
   CERRAR SESIÓN
</a>
{% endblock %}

{% block content %}

<div class="container mx-auto py-10 px-6">

    <h2 class="text-4xl font-extrabold text-center">ETAPA 3</h2>
    <p class="text-center text-xl mb-10 font-semibold">Diagnóstico</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- VIDEO -->
        <div class="bg-black h-[350px] flex items-center justify-center rounded-lg shadow-lg">
            <iframe class="w-full h-full"
                    src="{{ etapa.urlvideo }}"
                    frameborder="0" allowfullscreen>
            </iframe>
        </div>

        <!-- PANEL DERECHO -->
        <div class="p-6 rounded-lg shadow-md border bg-white">

            <h3 class="text-3xl font-bold text-center mb-6">{{ pregunta.titulo }}</h3>

            <p class="text-gray-700 mb-4">{{ pregunta.texto }}</p>

            {% if completada %}
                
                <!-- RESPUESTA DEL ESTUDIANTE -->
                <div class="p-4 bg-green-50 border border-green-300 rounded-lg text-gray-900">
                    <p class="font-semibold mb-2">Tu respuesta:</p>
                    <p>{{ respuesta }}</p>
                </div>

                <!-- RETROALIMENTACIÓN -->
                {% if pregunta.retroalimentacion_general %}
                <div class="mt-5 p-4 bg-blue-50 border border-blue-300 rounded-lg text-gray-900">
                    <p class="font-semibold">Retroalimentación del docente:</p>
                    <p>{{ pregunta.retroalimentacion_general }}</p>
                </div>
                {% endif %}

            {% else %}

                <!-- TEXTAREA -->
                <textarea id="respuesta-final"
                          class="w-full h-40 p-3 bg-gray-200 rounded-lg"
                          placeholder="Escribe aquí tu diagnóstico final…"></textarea>

                <!-- ENVIAR -->
                <button id="btn-enviar"
                        class="bg-blue-700 hover:bg-blue-800 text-white font-bold px-6 py-2 rounded-full mt-6 block mx-auto shadow">
                    ENVIAR RESPUESTA
                </button>

            {% endif %}
        </div>
    </div>
    {% if completada %}
        <a href="{% url 'casos:detalle_paciente' paciente.id %}"
            class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-full mt-10 block mx-auto w-1/3 text-center shadow">
            ETAPAS COMPLETADAS
        </a>
    {% endif %}

</div>


<!-- MODAL -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center w-96">
        <h2 class="text-2xl font-bold mb-4" id="modal-titulo"></h2>
        <p id="modal-texto" class="mb-6"></p>
        <button id="btn-modal-ok"
                class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-full font-bold">
            Entendido
        </button>
    </div>
</div>

<script>
let estudiante_id = "{{ request.session.estudiante_id }}";
let pregunta_id = "{{ pregunta.id }}";

// Variable para controlar qué hace el botón del modal
let modalRedirect = false;

// MODAL
function abrirModal(t, msg, redirect = false){
    document.getElementById("modal-titulo").innerHTML = t;
    document.getElementById("modal-texto").innerHTML = msg;

    // Guardamos si debe redirigir o no
    modalRedirect = redirect;

    document.getElementById("modal").classList.remove("hidden");
}

document.getElementById("btn-modal-ok")?.addEventListener("click", () => {

    document.getElementById("modal").classList.add("hidden");

    // Si el modal fue invocado con redirect = true → ir a detalle
    if(modalRedirect){
        window.location.href = "{% url 'casos:detalle_paciente' paciente.id %}";
    }
});

// ENVIAR RESPUESTA
document.getElementById("btn-enviar")?.addEventListener("click", function(){

    let texto = document.getElementById("respuesta-final").value.trim();

    if(texto === ""){
        abrirModal("⚠ Respuesta vacía", "Por favor escribe tu diagnóstico.", false);
        return;
    }

    fetch("{% url 'casos:validar_respuesta' %}", {
        method: "POST",
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
        body: new URLSearchParams({
            estudiante_id,
            pregunta_id,
            texto_respuesta: texto
        })
    })
    .then(r => r.json())
    .then(data => {
        if(data.ok){
            abrirModal(
                "✔ Respuesta enviada",
                data.retroalimentacion_general ?? "Tu respuesta fue guardada con éxito.",
                true //redirige CUANDO hay éxito
            );
        } else {
            abrirModal("Error", data.error, false); //errores NO redirigen
        }
    });
});
</script>

{% endblock %}