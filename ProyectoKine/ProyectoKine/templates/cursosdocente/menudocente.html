{% extends 'base_site.html' %}
{% load static %}

{% block title %}Men√∫ Docente - KineLearn{% endblock %}

{% block nav_buttons %}
    <a href="{% url 'login:logout' %}"
       class="bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow btn-nav-hover text-sm">
       CERRAR SESI√ìN
    </a>
{% endblock %}

{% block content %}

<style>
    .border-blue-custom {
        border: 4px solid #1e3a8a; /* Azul oscuro institucional */
    }
    /* Animaci√≥n suave para los modales */
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
</style>

<div class="flex-grow container mx-auto py-10 px-4 sm:px-6 lg:px-8 relative">

    <div class="flex flex-col xl:flex-row gap-8 items-start justify-center max-w-7xl mx-auto">

        <div class="flex-1 w-full">
            
            <div class="text-center mb-10 mt-2">
                <h2 class="text-5xl font-extrabold text-gray-900 mb-2">
                    ¬°Bienvenido/a a KineLearn!
                </h2>
                <p class="text-xl text-gray-600">
                    Administre sus cursos, revise solicitudes y gestione casos cl√≠nicos.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <div class="bg-white rounded-2xl shadow-xl p-8 text-center hover:scale-[1.02] transition-all duration-300 border border-gray-200 flex flex-col justify-between items-center h-96">
                    <div>
                        <div class="text-6xl mb-4">üìò</div>
                        <h3 class="text-2xl font-extrabold text-gray-900 mb-2">MIS CURSOS</h3>
                        <p class="text-gray-600 text-sm">
                            Acceda a todas sus asignaturas y a los estudiantes inscritos.
                        </p>
                    </div>
                    <a href="{% url 'cursos:mis_cursos' %}"
                       class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 w-full rounded-full block shadow-md transition mt-6">
                        ACCEDER
                    </a>
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-8 text-center hover:scale-[1.02] transition-all duration-300 border border-gray-200 flex flex-col justify-between items-center h-96">
                    <div>
                        <div class="text-6xl mb-4">ü©∫</div>
                        <h3 class="text-2xl font-extrabold text-gray-900 mb-2">CASOS CL√çNICOS</h3>
                        <p class="text-gray-600 text-sm">
                            Cree, edite y gestione pacientes, etapas y preguntas.
                        </p>
                    </div>
                    <a href="{% url 'cursos:gestion_casos' %}"
                       class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 w-full rounded-full block shadow-md transition mt-6">
                        ACCEDER
                    </a>
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-8 text-center hover:scale-[1.02] transition-all duration-300 border border-gray-200 flex flex-col justify-between items-center h-96">
                    <div>
                        <div class="text-6xl mb-4">üìù</div>
                        <h3 class="text-2xl font-extrabold text-gray-900 mb-2">SOLICITUDES</h3>
                        <p class="text-gray-600 text-sm">
                            Revise solicitudes de retroalimentaci√≥n enviadas por estudiantes.
                        </p>
                    </div>
                    <a href="{% url 'cursos:revisiones_docente' %}"
                       class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 w-full rounded-full block shadow-md transition mt-6">
                        VER SOLICITUDES
                    </a>
                </div>

            </div>
        </div>

        <div class="w-full xl:w-80 flex flex-col gap-4 shrink-0 mt-8 xl:mt-0">
            
            <button onclick="abrirModal('modal-perfil')" 
                    class="bg-blue-900 hover:bg-blue-800 text-white font-semibold text-lg px-4 py-3 rounded-lg shadow-md border border-blue-800 transition cursor-pointer w-full flex justify-center items-center gap-2"
                    title="Clic para editar perfil">
                <span>Hola, {{ user.nombre_docente }} {{ user.apellido_docente }}</span>
            </button>

            <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 transition-all duration-300">
                <div class="px-4 py-3 border-b flex justify-between items-center bg-gray-50 cursor-pointer hover:bg-gray-100 transition"
                     onclick="toggleNotificacionesDocente()">
                    
                    <div class="flex items-center gap-2">
                        <h5 class="text-blue-900 font-bold m-0 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bell-fill" viewBox="0 0 16 16">
                                <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zm.995-14.901a1 1 0 1 0-1.99 0A5.002 5.002 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901z"/>
                            </svg>
                            Notificaciones
                        </h5>
                        <svg id="chevron-docente" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-gray-500 transition-transform duration-300 -rotate-90" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </div>

                    {% if count_no_leidas > 0 %}
                        <span class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">{{ count_no_leidas }} nuevas</span>
                    {% endif %}
                </div>

                <div id="notificaciones-body-docente" class="hidden flex flex-col max-h-96 overflow-y-auto transition-all duration-300">
                    {% for notif in notificaciones %}
                        <a href="{% url 'cursos:revisiones_docente' %}?{{ notif.url_params }}" 
                           class="p-3 flex justify-between items-start gap-3 no-underline text-gray-800 hover:bg-blue-50 transition border-b border-gray-100 last:border-0 {% if notif.leido %}opacity-60 bg-gray-50{% endif %}"
                           onclick="marcarLeidoDocente({{ notif.id }})"> <div class="mt-1 shrink-0 relative">
                                <div class="bg-orange-100 p-2 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-orange-600 block" viewBox="0 0 16 16">
                                        <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"/>
                                        <path d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                    </svg>
                                </div>

                                {% if not notif.leido %}
                                    <span class="absolute -bottom-1 -left-1 h-3 w-3 bg-red-500 border-2 border-white rounded-full shadow-sm"></span>
                                {% endif %}
                            </div>

                            <div class="flex-grow">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-bold text-gray-900 text-sm">
                                        {{ notif.estudiante_nombre }}
                                    </span>
                                    <span class="text-[10px] uppercase tracking-wide font-bold px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 border border-blue-200">
                                        {{ notif.categoria }}
                                    </span>
                                </div>

                                <p class="text-xs text-gray-600 mb-1 leading-snug">
                                    Solicitud de revisi√≥n para el paciente <span class="font-semibold">{{ notif.paciente_nombre }}</span>.
                                </p>
                                
                                <div class="flex justify-between items-end mt-1">
                                    <span class="text-[10px] text-gray-400 italic truncate max-w-[120px]">
                                        {{ notif.curso_nombre }}
                                    </span>
                                    <small class="text-[10px] text-blue-600 font-bold whitespace-nowrap">
                                        {{ notif.fecha|timesince }} atr√°s
                                    </small>
                                </div>
                            </div>
                        </a>
                    {% empty %}
                        <div class="p-8 text-center text-gray-500">
                            <span class="text-2xl block mb-2 opacity-50">‚úÖ</span>
                            <p class="text-sm">No hay solicitudes pendientes.</p>
                        </div>
                    {% endfor %}
                </div>
                
                {% if notificaciones %}
                    <div class="bg-gray-50 p-2 text-center border-t">
                        <a href="{% url 'cursos:revisiones_docente' %}" class="text-xs text-blue-600 hover:underline font-semibold">
                            Ver todas las solicitudes
                        </a>
                    </div>
                {% endif %}
            </div>

        </div>

    </div>
</div>

<div id="modal-perfil" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden fade-in relative">
        
        <div class="bg-blue-900 px-6 py-4 flex justify-between items-center">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <span>üë§</span> Editar Perfil Docente
            </h3>
            <button onclick="cerrarModal('modal-perfil')" class="text-white hover:text-gray-300 text-2xl font-bold">&times;</button>
        </div>

        <div class="p-6">
            
            {% if messages %}
                <div class="mb-4">
                    {% for message in messages %}
                        <div class="p-3 rounded text-sm font-bold mb-2 
                                  {% if 'success' in message.tags %}bg-green-100 text-green-700 border border-green-200
                                  {% else %}bg-red-100 text-red-700 border border-red-200{% endif %}">
                            {{ message }}
                        </div>
                        {% endfor %}
                </div>
            {% endif %}

            <div id="form-datos-basicos">
                <form action="{% url 'login:editar_perfil_docente' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="tipo_accion" value="info">

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1">Nombre</label>
                            <input type="text" name="nombre" value="{{ user.nombre_docente }}" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1">Apellido</label>
                            <input type="text" name="apellido" value="{{ user.apellido_docente }}" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none">
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 text-xs font-bold mb-1">Correo Institucional</label>
                        <input type="email" name="correo" value="{{ user.correo_docente }}" required
                               class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none">
                    </div>

                    <div class="bg-gray-50 p-4 rounded border border-gray-200 mb-4">
                        <label class="block text-gray-600 text-xs font-bold mb-1">Contrase√±a Actual (Requerida para guardar)</label>
                        <div class="relative">
                            <input type="password" name="password_validacion" id="pass-val" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none pr-10">
                            <button type="button" onclick="togglePass('pass-val')" class="absolute right-2 top-2 text-gray-500 hover:text-blue-900">
                                üëÅÔ∏è
                            </button>
                        </div>
                        {% for message in messages %}
                            {% if 'error_pass_info' in message.tags %}
                                <p class="text-xs text-red-600 mt-1 font-bold">{{ message }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="flex flex-col gap-2">
                        <button type="submit" class="bg-blue-900 text-white font-bold py-2 rounded hover:bg-blue-800 transition shadow">
                            GUARDAR CAMBIOS
                        </button>
                        <button type="button" onclick="mostrarCambioPass()" class="text-blue-700 text-xs font-bold hover:underline py-2">
                            ¬øDesea cambiar su contrase√±a?
                        </button>
                    </div>
                </form>
            </div>

            <div id="form-password" class="hidden">
                <h4 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Seguridad</h4>
                <form action="{% url 'login:editar_perfil_docente' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="tipo_accion" value="password">

                    <div class="mb-4">
                        <label class="block text-gray-700 text-xs font-bold mb-1">Contrase√±a Actual</label>
                        <div class="relative">
                            <input type="password" name="password_actual" id="pass-act" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none pr-10">
                            <button type="button" onclick="togglePass('pass-act')" class="absolute right-2 top-2 text-gray-500 hover:text-blue-900">üëÅÔ∏è</button>
                        </div>
                        {% for message in messages %}
                            {% if 'error_pass_actual_cambio' in message.tags %}
                                <p class="text-xs text-red-600 mt-1 font-bold">{{ message }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-xs font-bold mb-1">Nueva Contrase√±a</label>
                        <div class="relative">
                            <input type="password" name="password_nueva" id="pass-new" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none pr-10">
                            <button type="button" onclick="togglePass('pass-new')" class="absolute right-2 top-2 text-gray-500 hover:text-blue-900">üëÅÔ∏è</button>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 text-xs font-bold mb-1">Confirmar Nueva Contrase√±a</label>
                        <div class="relative">
                            <input type="password" name="password_confirm" id="pass-conf" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none pr-10">
                            <button type="button" onclick="togglePass('pass-conf')" class="absolute right-2 top-2 text-gray-500 hover:text-blue-900">üëÅÔ∏è</button>
                        </div>
                        {% for message in messages %}
                            {% if 'error_pass_match' in message.tags %}
                                <p class="text-xs text-red-600 mt-1 font-bold">{{ message }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="flex gap-2">
                        <button type="button" onclick="ocultarCambioPass()" class="flex-1 bg-gray-300 text-gray-700 font-bold py-2 rounded hover:bg-gray-400 transition">
                            VOLVER
                        </button>
                        <button type="submit" class="flex-1 bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 transition shadow">
                            CONFIRMAR
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
function marcarLeidoDocente(id) {
    fetch('/cursos/api/notificacion-leida/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id })
    });
}

function toggleNotificacionesDocente() {
    const body = document.getElementById('notificaciones-body-docente');
    const chevron = document.getElementById('chevron-docente');
                
    if (body.classList.contains('hidden')) {
        body.classList.remove('hidden');
        chevron.classList.remove('-rotate-90');
    } else {
        body.classList.add('hidden');
        chevron.classList.add('-rotate-90');
    }
}
</script>

<script>
    // Control de Modales
    function abrirModal(id) { document.getElementById(id).classList.remove('hidden'); }
    function cerrarModal(id) { document.getElementById(id).classList.add('hidden'); }

    // Toggle formularios dentro del modal
    function mostrarCambioPass() {
        document.getElementById('form-datos-basicos').classList.add('hidden');
        document.getElementById('form-password').classList.remove('hidden');
    }
    function ocultarCambioPass() {
        document.getElementById('form-password').classList.add('hidden');
        document.getElementById('form-datos-basicos').classList.remove('hidden');
    }

    // Mostrar/Ocultar contrase√±a
    function togglePass(id) {
        const input = document.getElementById(id);
        input.type = input.type === "password" ? "text" : "password";
    }

    // L√≥gica autom√°tica al cargar la p√°gina
    window.onload = function() {
        // Verificamos si Django envi√≥ alg√∫n mensaje (√âxito o Error)
        {% if messages %}
            // 1. Abrimos el modal siempre que haya un mensaje para que el usuario lo vea
            abrirModal('modal-perfil');

            // 2. Revisamos si el mensaje pertenece a la pesta√±a de contrase√±a para cambiar de vista
            {% for message in messages %}
                {% if 'error_pass_actual_cambio' in message.tags or 'error_pass_match' in message.tags %}
                    mostrarCambioPass();
                {% endif %}
            {% endfor %}
        {% endif %}
    };
</script>

{% endblock %}
