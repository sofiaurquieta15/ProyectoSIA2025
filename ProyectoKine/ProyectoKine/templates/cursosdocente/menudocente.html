{% extends 'base_site.html' %}
{% load static %}

{% block title %}Men√∫ Docente - KineLearn{% endblock %}

{% block nav_buttons %}
    <a href="{% url 'login:logout' %}"
       class="bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow btn-nav-hover text-sm">
       CERRAR SESI√ìN
    </a>
{% endblock %}

{% block content %}

<style>
    .border-blue-custom {
        border: 4px solid #1e3a8a; /* Azul oscuro institucional */
    }
    /* Animaci√≥n suave para los modales */
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
</style>

<div class="flex-grow container mx-auto py-10 px-4 sm:px-6 lg:px-8 relative">

    <button onclick="abrirModal('modal-perfil')" 
            class="hidden lg:block absolute top-0 right-10 bg-blue-900 hover:bg-blue-800 text-white font-semibold text-lg px-6 py-2 rounded-b-lg shadow-md border-t-0 border-x-2 border-b-2 border-blue-800 transition cursor-pointer z-10"
            title="Clic para editar perfil">
        Docente: {{ user.nombre_docente }} {{ user.apellido_docente }}
    </button>

    <div class="text-center mb-12 mt-8">
        <h2 class="text-5xl font-extrabold text-gray-900 mb-2">
            Panel Docente
        </h2>
        <p class="text-xl text-gray-600">Gestione sus cursos y evaluaciones</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 justify-items-center max-w-7xl mx-auto">
        
        <div class="w-full max-w-sm p-8 bg-white shadow-2xl rounded-xl text-center hover:scale-[1.03] transition duration-300 border-blue-custom flex flex-col justify-between h-80">
            <div>
                <div class="text-6xl mb-4">üéì</div> 
                <h3 class="text-2xl font-extrabold text-gray-900 mb-2 uppercase">MIS CURSOS</h3>
                <p class="text-gray-600 text-sm">Visualice sus asignaturas y alumnos inscritos.</p>
            </div>
            
            <a href="{% url 'cursos:mis_cursos' %}" 
               class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 w-full rounded-full mt-6 block text-center shadow-lg uppercase transition">
                GESTIONAR
            </a>
        </div>

        <div class="w-full max-w-sm p-8 bg-white shadow-2xl rounded-xl text-center hover:scale-[1.03] transition duration-300 border-blue-custom flex flex-col justify-between h-80">
            <div>
                <div class="text-6xl mb-4">üè•</div> 
                <h3 class="text-2xl font-extrabold text-gray-900 mb-2 uppercase">CASOS CL√çNICOS</h3>
                <p class="text-gray-600 text-sm">Cree y edite pacientes, etapas y preguntas.</p>
            </div>

            <a href="{% url 'cursos:gestion_casos' %}" 
                class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 w-full rounded-full mt-6 block text-center shadow-lg uppercase transition">
                GESTIONAR CASOS
            </a>
        </div>

        <div class="w-full max-w-sm p-8 bg-white shadow-2xl rounded-xl text-center hover:scale-[1.03] transition duration-300 border-blue-custom flex flex-col justify-between h-80">
            <div>
                <div class="text-6xl mb-4">‚úÖ</div> 
                <h3 class="text-2xl font-extrabold text-gray-900 mb-2 uppercase">REVISIONES</h3>
                <p class="text-gray-600 text-sm">Responda a las solicitudes de retroalimentaci√≥n.</p>
            </div>

            <a href="{% url 'cursos:revisiones_docente' %}" 
                class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 w-full rounded-full mt-6 block text-center shadow-lg uppercase transition">
                VER SOLICITUDES
            </a>
        </div>

    </div>
</div>

<div id="modal-perfil" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden fade-in relative">
        
        <div class="bg-blue-900 px-6 py-4 flex justify-between items-center">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <span>üë§</span> Editar Perfil Docente
            </h3>
            <button onclick="cerrarModal('modal-perfil')" class="text-white hover:text-gray-300 text-2xl font-bold">&times;</button>
        </div>

        <div class="p-6">
            
            {% if messages %}
                <div class="mb-4">
                    {% for message in messages %}
                        <div class="p-3 rounded text-sm font-bold mb-2 
                                  {% if 'success' in message.tags %}bg-green-100 text-green-700 border border-green-200
                                  {% else %}bg-red-100 text-red-700 border border-red-200{% endif %}">
                            {{ message }}
                        </div>
                        {% endfor %}
                </div>
            {% endif %}

            <div id="form-datos-basicos">
                <form action="{% url 'login:editar_perfil_docente' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="tipo_accion" value="info">

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1">Nombre</label>
                            <input type="text" name="nombre" value="{{ user.nombre_docente }}" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1">Apellido</label>
                            <input type="text" name="apellido" value="{{ user.apellido_docente }}" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none">
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 text-xs font-bold mb-1">Correo Institucional</label>
                        <input type="email" name="correo" value="{{ user.correo_docente }}" required
                               class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none">
                    </div>

                    <div class="bg-gray-50 p-4 rounded border border-gray-200 mb-4">
                        <label class="block text-gray-600 text-xs font-bold mb-1">Contrase√±a Actual (Requerida para guardar)</label>
                        <div class="relative">
                            <input type="password" name="password_validacion" id="pass-val" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none pr-10">
                            <button type="button" onclick="togglePass('pass-val')" class="absolute right-2 top-2 text-gray-500 hover:text-blue-900">
                                üëÅÔ∏è
                            </button>
                        </div>
                        {% for message in messages %}
                            {% if 'error_pass_info' in message.tags %}
                                <p class="text-xs text-red-600 mt-1 font-bold">{{ message }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="flex flex-col gap-2">
                        <button type="submit" class="bg-blue-900 text-white font-bold py-2 rounded hover:bg-blue-800 transition shadow">
                            GUARDAR CAMBIOS
                        </button>
                        <button type="button" onclick="mostrarCambioPass()" class="text-blue-700 text-xs font-bold hover:underline py-2">
                            ¬øDesea cambiar su contrase√±a?
                        </button>
                    </div>
                </form>
            </div>

            <div id="form-password" class="hidden">
                <h4 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Seguridad</h4>
                <form action="{% url 'login:editar_perfil_docente' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="tipo_accion" value="password">

                    <div class="mb-4">
                        <label class="block text-gray-700 text-xs font-bold mb-1">Contrase√±a Actual</label>
                        <div class="relative">
                            <input type="password" name="password_actual" id="pass-act" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none pr-10">
                            <button type="button" onclick="togglePass('pass-act')" class="absolute right-2 top-2 text-gray-500 hover:text-blue-900">üëÅÔ∏è</button>
                        </div>
                        {% for message in messages %}
                            {% if 'error_pass_actual_cambio' in message.tags %}
                                <p class="text-xs text-red-600 mt-1 font-bold">{{ message }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-xs font-bold mb-1">Nueva Contrase√±a</label>
                        <div class="relative">
                            <input type="password" name="password_nueva" id="pass-new" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none pr-10">
                            <button type="button" onclick="togglePass('pass-new')" class="absolute right-2 top-2 text-gray-500 hover:text-blue-900">üëÅÔ∏è</button>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 text-xs font-bold mb-1">Confirmar Nueva Contrase√±a</label>
                        <div class="relative">
                            <input type="password" name="password_confirm" id="pass-conf" required
                                   class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900 outline-none pr-10">
                            <button type="button" onclick="togglePass('pass-conf')" class="absolute right-2 top-2 text-gray-500 hover:text-blue-900">üëÅÔ∏è</button>
                        </div>
                        {% for message in messages %}
                            {% if 'error_pass_match' in message.tags %}
                                <p class="text-xs text-red-600 mt-1 font-bold">{{ message }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="flex gap-2">
                        <button type="button" onclick="ocultarCambioPass()" class="flex-1 bg-gray-300 text-gray-700 font-bold py-2 rounded hover:bg-gray-400 transition">
                            VOLVER
                        </button>
                        <button type="submit" class="flex-1 bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 transition shadow">
                            CONFIRMAR
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
    // Control de Modales
    function abrirModal(id) { document.getElementById(id).classList.remove('hidden'); }
    function cerrarModal(id) { document.getElementById(id).classList.add('hidden'); }

    // Toggle formularios dentro del modal
    function mostrarCambioPass() {
        document.getElementById('form-datos-basicos').classList.add('hidden');
        document.getElementById('form-password').classList.remove('hidden');
    }
    function ocultarCambioPass() {
        document.getElementById('form-password').classList.add('hidden');
        document.getElementById('form-datos-basicos').classList.remove('hidden');
    }

    // Mostrar/Ocultar contrase√±a
    function togglePass(id) {
        const input = document.getElementById(id);
        input.type = input.type === "password" ? "text" : "password";
    }

    // L√≥gica autom√°tica al cargar la p√°gina
    window.onload = function() {
        // Verificamos si Django envi√≥ alg√∫n mensaje (√âxito o Error)
        {% if messages %}
            // 1. Abrimos el modal siempre que haya un mensaje para que el usuario lo vea
            abrirModal('modal-perfil');

            // 2. Revisamos si el mensaje pertenece a la pesta√±a de contrase√±a para cambiar de vista
            {% for message in messages %}
                {% if 'error_pass_actual_cambio' in message.tags or 'error_pass_match' in message.tags %}
                    mostrarCambioPass();
                {% endif %}
            {% endfor %}
        {% endif %}
    };
</script>

{% endblock %}