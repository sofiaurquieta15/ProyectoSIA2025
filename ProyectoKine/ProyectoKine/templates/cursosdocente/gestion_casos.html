{% extends 'base_site.html' %}
{% load static %}

{% block title %}Gesti√≥n de Casos{% endblock %}

{% block nav_buttons %}
    <a href="{% url 'cursos:mis_cursos' %}" class="bg-white hover:bg-gray-200 text-blue-900 font-bold py-2 px-4 rounded-full shadow btn-nav-hover text-sm">
        MIS CURSOS
    </a>
    <a href="{% url 'cursos:revisiones_docente' %}" class="bg-white hover:bg-gray-200 text-blue-900 font-bold py-2 px-4 rounded-full shadow btn-nav-hover text-sm">
        REVISIONES
    </a>
    <a href="{% url 'login:logout' %}" class="bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow btn-nav-hover text-sm">
        CERRAR SESI√ìN
    </a>
{% endblock %}

{% block content %}
<style>
    .border-blue-custom { border: 4px solid #1e3a8a; }
    .btn-blue { background-color: #1e3a8a; color: white; transition: all 0.2s; }
    .btn-blue:hover { background-color: #1e40af; transform: translateY(-1px); }
    /* Estilos para el scroll del modal */
    .lista-pacientes::-webkit-scrollbar { width: 8px; }
    .lista-pacientes::-webkit-scrollbar-track { background: #f1f1f1; }
    .lista-pacientes::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .lista-pacientes::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>

<div class="container mx-auto py-10 px-4 max-w-6xl">

    <h2 class="text-4xl font-extrabold text-center text-gray-900 mb-2">GESTI√ìN DE CASOS</h2>
    <p class="text-center text-gray-600 mb-12">Panel de administraci√≥n docente</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        
        <div class="bg-white p-6 rounded-xl shadow-lg border-blue-custom text-center flex flex-col justify-between h-80 hover:scale-105 transition duration-300">
            <div>
                <div class="text-5xl mb-4">üéì</div>
                <h3 class="text-2xl font-bold text-gray-800 uppercase">Crear Clase</h3>
                <p class="text-sm text-gray-600 mt-2">Define el nombre y objetivos de la asignatura.</p>
            </div>
            <div class="flex gap-2 w-full mt-4">
                <button onclick="abrirModal('modal-crear-curso')" class="btn-blue flex-1 py-3 rounded-l-full uppercase shadow font-bold text-sm">
                    Crear
                </button>
                <button onclick="abrirModal('modal-lista-cursos')" class="bg-gray-500 hover:bg-gray-600 text-white flex-1 py-3 rounded-r-full uppercase shadow font-bold text-sm transition border-l border-white">
                    Editar
                </button>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg border-blue-custom text-center flex flex-col justify-between h-80 hover:scale-105 transition duration-300">
            <div>
                <div class="text-5xl mb-4">üë§</div>
                <h3 class="text-2xl font-bold text-gray-800 uppercase">Crear Paciente</h3>
                <p class="text-sm text-gray-600 mt-2">Registra datos del paciente y as√≠gnalo a un curso.</p>
            </div>
            <button onclick="abrirModal('modal-crear-paciente')" class="btn-blue font-bold py-3 rounded-full w-full uppercase shadow">CREAR</button>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg border-blue-custom text-center flex flex-col justify-between h-80 hover:scale-105 transition duration-300">
            <div>
                <div class="text-5xl mb-4">üìã</div>
                <h3 class="text-2xl font-bold text-gray-800 uppercase">Configurar Etapas</h3>
                <p class="text-sm text-gray-600 mt-2">Busca pacientes, gestiona sus etapas y su visibilidad.</p>
            </div>
            
            <button onclick="abrirBuscadorPacientes()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-full w-full uppercase shadow flex items-center justify-center gap-2 transition">
                <span>üîç BUSCAR Y EDITAR</span>
            </button>
        </div>

    </div>
</div>

<div id="modal-crear-curso" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-96 border-blue-custom relative">
        
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-xl font-bold text-gray-800">Nuevo Curso</h3>
            <button onclick="cerrarModal('modal-crear-curso')" class="text-gray-400 hover:text-red-500 font-bold text-2xl leading-none">&times;</button>
        </div>

        <form id="form-crear-curso">
            {% csrf_token %}
            {{ form_curso.as_p }}
            <button type="button" onclick="enviarFormulario('crear-curso', '{% url 'cursos:crear_curso_ajax' %}')" class="btn-blue w-full py-2 rounded mt-4 font-bold">GUARDAR</button>
        </form>
    </div>
</div>

<div id="modal-lista-cursos" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-96 border-blue-custom">
        
        <div class="flex justify-between items-center border-b pb-2 mb-2">
            <h3 class="text-xl font-bold text-gray-800">Editar Curso</h3>
            <button onclick="cerrarModal('modal-lista-cursos')" class="text-gray-400 hover:text-red-500 font-bold text-2xl leading-none">&times;</button>
        </div>

        <p class="text-sm text-gray-500 mb-4">Selecciona el curso a modificar:</p>
        
        <div class="max-h-60 overflow-y-auto space-y-2">
            {% for curso in mis_cursos %}
                <button onclick="cargarCursoParaEditar({{ curso.id }})" 
                        class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-blue-50 hover:text-blue-800 rounded border border-gray-200 transition flex justify-between items-center group">
                    <span class="font-semibold">{{ curso.nombrecurso }}</span>
                    <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded group-hover:bg-blue-200 group-hover:text-blue-800">Editar</span>
                </button>
            {% empty %}
                <p class="text-center text-gray-500 py-4">No tienes cursos creados.</p>
            {% endfor %}
        </div>
    </div>
</div>

<div id="modal-editar-curso" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[60]">
    <div class="bg-white p-6 rounded-lg shadow-xl w-96 border-blue-custom relative">
        
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-xl font-bold text-blue-900">Editar Detalles</h3>
            <button onclick="cerrarModal('modal-editar-curso')" class="text-gray-400 hover:text-red-500 font-bold text-2xl leading-none">&times;</button>
        </div>
        
        <form id="form-editar-curso">
            <input type="hidden" id="edit_curso_id" name="curso_id">

            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-1">Nombre del Curso</label>
                <input type="text" id="edit_nombrecurso" name="nombrecurso" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-1">Objetivos</label>
                <textarea id="edit_objetivos" name="objetivos" rows="3" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>

            <button type="button" onclick="guardarCambiosCurso()" class="btn-blue w-full py-2 rounded font-bold shadow">GUARDAR CAMBIOS</button>
        </form>
    </div>
</div>

<div id="modal-exito" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-[70]">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-80 text-center transform transition-all scale-100">
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
            <svg class="h-10 w-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">¬°Guardado!</h3>
        <p class="text-gray-500" id="mensaje-exito-texto">Operaci√≥n realizada con √©xito.</p>
    </div>
</div>

<div id="modal-crear-paciente" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-[700px] border-blue-custom max-h-[90vh] overflow-y-auto relative">
        
        <div class="flex justify-between items-center mb-6 border-b pb-2">
            <h3 class="text-2xl font-bold text-blue-900">Nuevo Paciente</h3>
            <button onclick="cerrarModal('modal-crear-paciente')" class="text-gray-400 hover:text-red-500 font-bold text-2xl leading-none">&times;</button>
        </div>
        
        <form id="form-crear-paciente">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                
                <div class="col-span-2">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Nombre Completo</label>
                    {{ form_paciente.nombre }}
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Edad</label>
                    {{ form_paciente.edad }}
                    <p class="text-xs text-gray-400 mt-1">Rango permitido: 0 a 110 a√±os</p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Sexo</label>
                    {{ form_paciente.sexo }}
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Ocupaci√≥n</label>
                    {{ form_paciente.ocupacion }}
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Descripci√≥n del Caso</label>
                    {{ form_paciente.descripcion }}
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Asignar a Curso</label>
                    {{ form_paciente.id_curso }}
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Tipo de Caso</label>
                    {{ form_paciente.tipo_caso }}
                    
                    <button type="button" onclick="abrirModal('modal-tipo-caso')" class="mt-2 w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-3 rounded text-xs transition shadow-sm flex items-center justify-center gap-2">
                        <span class="text-lg leading-none">+</span> Nuevo Tipo
                    </button>
                </div>
            </div>

            <div class="pt-4 border-t border-gray-200">
                <button type="button" onclick="validarYGuardarPaciente('{% url 'cursos:crear_paciente_ajax' %}')" class="btn-blue w-full py-3 rounded font-bold shadow hover:shadow-lg transition">
                    GUARDAR PACIENTE
                </button>
            </div>
        </form>
    </div>
</div>

<div id="modal-tipo-caso" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[60]">
    <div class="bg-white p-6 rounded-lg w-80 border-2 border-yellow-500">
        <h3 class="text-lg font-bold mb-2">Crear Tipo de Caso</h3>
        <form id="form-tipo-caso">
            {% csrf_token %}
            {{ form_tipo_caso.as_p }}
            <button type="button" onclick="guardarTipoCaso()" class="bg-yellow-500 text-white font-bold w-full py-2 rounded mt-2">Guardar</button>
            <button type="button" onclick="cerrarModal('modal-tipo-caso')" class="text-gray-500 w-full text-xs mt-2">Cancelar</button>
        </form>
    </div>
</div>


<div id="modal-buscar-paciente" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-start pt-10 z-50 transition-opacity backdrop-blur-sm">
    
    <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
        
        <div class="bg-gray-100 px-6 py-4 border-b flex justify-between items-center">
            <div>
                <h3 class="text-xl font-extrabold text-gray-800">üîç BUSCAR PACIENTE</h3>
                <p class="text-xs text-gray-500">Filtra por curso, estado o tipo para encontrar el caso r√°pidamente.</p>
            </div>
            <button onclick="cerrarModal('modal-buscar-paciente')" class="text-gray-400 hover:text-red-500 font-bold text-2xl transition">&times;</button>
        </div>

        <div class="p-6 bg-white border-b grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="col-span-1 md:col-span-4 mb-2">
                <input type="text" id="filtro-nombre" placeholder="Escribe el nombre del paciente..." class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-gray-500 focus:outline-none text-lg">
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Clase / Curso</label>
                <select id="filtro-curso" class="w-full p-2 border rounded bg-white text-sm focus:ring-gray-500">
                    <option value="todos">Todos los cursos</option>
                </select>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Tipo de Caso</label>
                <select id="filtro-tipo" class="w-full p-2 border rounded bg-white text-sm focus:ring-gray-500">
                    <option value="todos">Todos los tipos</option>
                </select>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Visibilidad</label>
                <select id="filtro-visibilidad" class="w-full p-2 border rounded bg-white text-sm focus:ring-gray-500">
                    <option value="todos">Cualquier estado</option>
                    <option value="visible">üëÅÔ∏è Visible (Publicado)</option>
                    <option value="oculto">üîí Oculto (Borrador)</option>
                </select>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Progreso</label>
                <select id="filtro-progreso" class="w-full p-2 border rounded bg-white text-sm focus:ring-gray-500">
                    <option value="todos">Cualquier progreso</option>
                    <option value="completo">‚úÖ Terminado</option>
                    <option value="incompleto">üöß Incompleto</option>
                </select>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto bg-gray-50 p-6 lista-pacientes">
            <div id="contenedor-pacientes" class="grid grid-cols-1 gap-3">
                </div>
            <div id="no-resultados" class="hidden text-center py-10 text-gray-400">
                <p class="text-4xl mb-2">üòï</p>
                <p>No se encontraron pacientes con esos filtros.</p>
            </div>
        </div>
        
        <div class="bg-gray-100 p-3 text-right text-xs text-gray-500 border-t">
            Mostrando <span id="contador-resultados" class="font-bold">0</span> pacientes
        </div>
    </div>
</div>

<div id="modal-error" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-[80]">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center transform transition-all scale-100 border-t-8 border-red-500">
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
            <svg class="h-10 w-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">¬°Atenci√≥n!</h3>
        
        <div id="mensaje-error-texto" class="text-gray-600 text-sm mb-6 text-left bg-red-50 p-4 rounded border border-red-100 max-h-40 overflow-y-auto">
            </div>

        <button onclick="cerrarModal('modal-error')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full shadow transition w-full">
            ENTENDIDO
        </button>
    </div>
</div>

<script>
// === LOGICA PARA EDITAR CURSO ===
function cargarCursoParaEditar(id) {
    // 1. YA NO CERRAMOS el modal de lista aqu√≠.
    // Al dejarlo abierto, el nuevo modal (que tiene fondo oscuro) se montar√° encima,
    // creando el efecto de "oscurecer" el modal de atr√°s.
    
    const url = `/cursos/api/obtener/curso/${id}/`; 

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert("Error: " + data.error);
            } else {
                // Llenar formulario
                document.getElementById('edit_curso_id').value = id;
                document.getElementById('edit_nombrecurso').value = data.nombrecurso;
                document.getElementById('edit_objetivos').value = data.objetivos;

                // Abrir modal de edici√≥n (z-index 60) sobre el de lista (z-index 50)
                abrirModal('modal-editar-curso');
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error al cargar datos del curso.");
        });
}

function guardarCambiosCurso() {
    const id = document.getElementById('edit_curso_id').value;
    const form = document.getElementById('form-editar-curso');
    const formData = new FormData(form);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Limpiar errores visuales
    form.querySelectorAll('.error-text-inline').forEach(el => el.remove());
    form.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500', 'bg-red-50'));

    const url = `/cursos/api/guardar/curso/${id}/`;

    fetch(url, {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': csrfToken }
    })
    .then(r => r.json())
    .then(data => {
        if (data.ok) {
            cerrarModal('modal-editar-curso');
            cerrarModal('modal-lista-cursos');
            mostrarPopupExito("Curso actualizado correctamente.");
        } else {
            // ERROR: Popup + Inline
            mostrarPopupError("Tienes datos incompletos.");
            marcarErroresInline('form-editar-curso', data.error);
        }
    })
    .catch(err => console.error(err));
}

// Funci√≥n auxiliar para manejar el popup de √©xito
function mostrarPopupExito(mensaje) {
    const modal = document.getElementById('modal-exito');
    document.getElementById('mensaje-exito-texto').innerText = mensaje;
    
    // Mostrar modal
    modal.classList.remove('hidden');
    
    // Esperar 1.5 segundos y recargar la p√°gina
    setTimeout(() => {
        location.reload();
    }, 1500);
}
</script>

<script id="data-pacientes" type="application/json">
[
    {% for p in mis_pacientes %}
    {
        "id": "{{ p.id }}",
        "nombre": "{{ p.nombre }}",
        "curso_id": "{{ p.id_curso.id }}",
        "curso_nombre": "{{ p.id_curso.nombrecurso }}",
        "tipo_id": "{{ p.tipo_caso.id }}",
        "tipo_nombre": "{{ p.tipo_caso.nombre }}",
        "visible": {% if p.visible %}true{% else %}false{% endif %},
        "completo": {% if p.completo %}true{% else %}false{% endif %} 
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>

<script>
function validarYGuardarPaciente(url) {
    const formId = 'form-crear-paciente';
    const form = document.getElementById(formId);
    
    // Limpiar visualmente antes de validar
    form.querySelectorAll('.error-text-inline').forEach(el => el.remove());
    form.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500', 'bg-red-50'));

    let inputEdad = document.getElementById('id_edad') || form.querySelector('[name="edad"]');

    // 1. Validaci√≥n Local (Edad)
    if (inputEdad) {
        const edad = parseInt(inputEdad.value);
        if (isNaN(edad) || edad < 0 || edad > 110) {
            
            // Usamos la misma l√≥gica visual: Popup General + Mensaje Inline simulado
            mostrarPopupError("Tienes datos incompletos.");
            
            // Simular estructura de error para usar nuestra funcion
            // (Esto pinta el mensaje debajo del label Edad)
            const errorSimulado = { 'edad': ['Rango inv√°lido'] }; 
            marcarErroresInline(formId, errorSimulado);
            
            return; // Detener
        }
    }

    const formData = new FormData(form);
    
    fetch(url, { method: 'POST', body: formData })
    .then(r => r.json())
    .then(data => {
        if(data.ok) {
            cerrarModal('modal-crear-paciente');
            mostrarPopupExito("Paciente creado exitosamente"); 
        } else {
            // ERROR DJANGO
            mostrarPopupError("Tienes datos incompletos.");
            marcarErroresInline(formId, data.error);
        }
    })
    .catch(error => {
        mostrarPopupError("Error de conexi√≥n.");
    });
}

// === LOGICA GLOBAL DE MODALES ===
function abrirModal(id) { document.getElementById(id).classList.remove('hidden'); }
function cerrarModal(id) { document.getElementById(id).classList.add('hidden'); }

// === LOGICA DEL BUSCADOR DE PACIENTES ===
let todosPacientes = [];

function abrirBuscadorPacientes() {
    // 1. Cargar datos si es la primera vez
    if (todosPacientes.length === 0) {
        const rawData = document.getElementById('data-pacientes').textContent;
        try {
            todosPacientes = JSON.parse(rawData);
            inicializarFiltros(); // Llenar selects
        } catch (e) {
            console.error("Error leyendo datos de pacientes", e);
        }
    }
    
    // 2. Renderizar inicial
    renderizarPacientes(todosPacientes);
    
    // 3. Mostrar modal
    abrirModal('modal-buscar-paciente');
    document.getElementById('filtro-nombre').focus();
}

function inicializarFiltros() {
    // Extraer cursos √∫nicos y tipos √∫nicos para llenar los selects
    const cursosMap = new Map();
    const tiposMap = new Map();

    todosPacientes.forEach(p => {
        cursosMap.set(p.curso_id, p.curso_nombre);
        tiposMap.set(p.tipo_id, p.tipo_nombre);
    });

    const selCurso = document.getElementById('filtro-curso');
    cursosMap.forEach((nombre, id) => {
        selCurso.add(new Option(nombre, id));
    });

    const selTipo = document.getElementById('filtro-tipo');
    tiposMap.forEach((nombre, id) => {
        selTipo.add(new Option(nombre, id));
    });

    // Agregar listeners para filtrar al cambiar cualquier cosa
    const inputs = ['filtro-nombre', 'filtro-curso', 'filtro-tipo', 'filtro-visibilidad', 'filtro-progreso'];
    inputs.forEach(id => {
        document.getElementById(id).addEventListener('input', filtrarPacientes);
    });
}

function filtrarPacientes() {
    const texto = document.getElementById('filtro-nombre').value.toLowerCase();
    const curso = document.getElementById('filtro-curso').value;
    const tipo = document.getElementById('filtro-tipo').value;
    const visibilidad = document.getElementById('filtro-visibilidad').value;
    const progreso = document.getElementById('filtro-progreso').value;

    const filtrados = todosPacientes.filter(p => {
        // Filtro Texto
        if (!p.nombre.toLowerCase().includes(texto)) return false;
        
        // Filtro Curso
        if (curso !== 'todos' && p.curso_id !== curso) return false;
        
        // Filtro Tipo
        if (tipo !== 'todos' && p.tipo_id !== tipo) return false;
        
        // Filtro Visibilidad
        if (visibilidad === 'visible' && !p.visible) return false;
        if (visibilidad === 'oculto' && p.visible) return false;

        // Filtro Progreso (Requiere el campo en models, si no existe asumimos siempre true para no romper)
        if (progreso === 'completo' && !p.completo) return false;
        if (progreso === 'incompleto' && p.completo) return false;

        return true;
    });

    renderizarPacientes(filtrados);
}

function renderizarPacientes(lista) {
    const contenedor = document.getElementById('contenedor-pacientes');
    const noResultados = document.getElementById('no-resultados');
    const contador = document.getElementById('contador-resultados');
    
    contenedor.innerHTML = '';
    contador.innerText = lista.length;

    if (lista.length === 0) {
        noResultados.classList.remove('hidden');
        return;
    }
    noResultados.classList.add('hidden');

    lista.forEach(p => {
        // Etiquetas din√°micas
        const badgeVisible = p.visible 
            ? `<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded border border-green-200">VISIBLE</span>` 
            : `<span class="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded border border-gray-200">OCULTO</span>`;
        
        const badgeCompleto = p.completo
            ? `<span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded border border-blue-200">TERMINADO</span>`
            : `<span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded border border-yellow-200">EN PROCESO</span>`;

        const card = document.createElement('div');
        card.className = "bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition flex justify-between items-center group";
        card.innerHTML = `
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <h4 class="font-bold text-lg text-blue-900 group-hover:text-blue-600 transition">${p.nombre}</h4>
                    ${badgeVisible}
                    ${badgeCompleto}
                </div>
                <div class="text-sm text-gray-500 flex gap-4">
                    <span>üéì ${p.curso_nombre}</span>
                    <span>üè• ${p.tipo_nombre}</span>
                </div>
            </div>
            <button onclick="irConfiguracion(${p.id})" class="bg-blue-50 text-blue-700 hover:bg-blue-600 hover:text-white border border-blue-200 font-bold py-2 px-6 rounded-full transition text-sm">
                CONFIGURAR ‚ûú
            </button>
        `;
        contenedor.appendChild(card);
    });
}

function irConfiguracion(id) {
    window.location.href = `/cursos/configurar-etapas/${id}/`;
}

// === AJAX CREAR (Tu c√≥digo existente) ===
function enviarFormulario(formId, url) {
    const form = document.getElementById('form-' + formId);
    const formData = new FormData(form);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Limpiar errores previos antes de enviar
    form.querySelectorAll('.error-text-inline').forEach(el => el.remove());
    form.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500', 'bg-red-50'));

    fetch(url, { 
        method: 'POST', 
        body: formData, 
        headers: { 'X-CSRFToken': csrfToken }
    })
    .then(r => r.json()).then(data => {
        if(data.ok) { 
            cerrarModal('modal-' + formId);
            mostrarPopupExito(formId === 'crear-curso' ? 'Curso creado exitosamente' : 'Guardado exitosamente'); 
            setTimeout(() => location.reload(), 1500);
        } 
        else { 
            // 1. Popup General
            mostrarPopupError("Tienes datos incompletos.");
            // 2. Marcar campos en rojo
            marcarErroresInline('form-' + formId, data.error);
        }
    })
    .catch(error => {
        mostrarPopupError("Error de conexi√≥n.");
    });
}

// === AJAX TIPO CASO (Tu c√≥digo existente) ===
function guardarTipoCaso() {
    const formId = 'form-tipo-caso';
    const form = document.getElementById(formId);
    const formData = new FormData(form);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Limpiar
    form.querySelectorAll('.error-text-inline').forEach(el => el.remove());

    fetch("{% url 'cursos:crear_tipo_caso_ajax' %}", { 
        method: 'POST', 
        body: formData,
        headers: { 'X-CSRFToken': csrfToken }
    })
    .then(r => r.json())
    .then(data => {
        if(data.ok) {
            // ... (Tu l√≥gica de agregar al select se mantiene igual) ...
            let select = document.getElementById('id_tipo_caso');
            if (!select) select = document.querySelector('select[name="tipo_caso"]');
            if (select) {
                const nuevaOpcion = new Option(data.nombre, data.id);
                select.add(nuevaOpcion);
                select.value = data.id;
            }
            
            form.reset();
            cerrarModal('modal-tipo-caso');
            mostrarPopupExito("Nuevo tipo de caso creado.");
        } else { 
            // ERROR
            mostrarPopupError("Tienes datos incompletos.");
            marcarErroresInline(formId, data.error);
        }
    })
    .catch(error => {
        mostrarPopupError("Error de conexi√≥n.");
    });
}

function mostrarPopupError(mensajeCustom) {
    const contenedor = document.getElementById('mensaje-error-texto');
    // Si no enviamos mensaje, usamos el default
    const texto = mensajeCustom || "Tienes datos incompletos.";
    
    contenedor.innerHTML = `<p class="font-bold text-center text-gray-700 text-lg">${texto}</p>`;
    document.getElementById('modal-error').classList.remove('hidden');
}

// 2. ERRORES INLINE (Pone "¬°Falta completar!" debajo del label)
function marcarErroresInline(formId, errorData) {
    const form = document.getElementById(formId);
    if (!form) return;

    // A. Limpiar errores previos (borrar los mensajes rojos viejos)
    form.querySelectorAll('.error-text-inline').forEach(el => el.remove());
    form.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500', 'bg-red-50'));

    // B. Parsear errores
    try {
        if (typeof errorData === 'string') errorData = JSON.parse(errorData);
        
        // C. Recorrer campos con error
        if (typeof errorData === 'object' && errorData !== null) {
            for (const campo in errorData) {
                if (campo === '__all__') continue;

                // 1. Buscar el input
                const input = form.querySelector(`[name="${campo}"]`);
                
                if (input) {
                    // Marcar el borde del input en rojo
                    input.classList.add('border-red-500', 'bg-red-50');

                    // 2. Buscar el Label asociado para poner el texto debajo
                    let label = null;
                    
                    // Intento 1: Label por atributo 'for'
                    if (input.id) {
                        label = form.querySelector(`label[for="${input.id}"]`);
                    }
                    
                    // Intento 2: Label cercano (hermano anterior o padre)
                    if (!label) {
                        // Buscar en el contenedor padre (para tus formularios manuales)
                        if (input.parentElement) {
                            label = input.parentElement.querySelector('label');
                        }
                    }

                    // 3. Insertar mensaje "¬°Falta completar!"
                    if (label) {
                        const msg = document.createElement('div');
                        msg.className = 'error-text-inline text-red-600 text-xs font-bold mt-1 mb-1 animate-pulse';
                        msg.innerText = '‚ö†Ô∏è ¬°Falta completar!';
                        
                        // Insertar JUSTO DESPU√âS del label (antes del input)
                        label.after(msg);
                    }
                }
            }
        }
    } catch (e) {
        console.error("Error mostrando inlines", e);
    }
}
</script>
{% endblock %}